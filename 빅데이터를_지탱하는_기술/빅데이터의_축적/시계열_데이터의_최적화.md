# 시계열 데이터의 최적화
스트리밍 형의 메세지 배송에는 메세지가 도착할 때까지의 시간 지연이 문제다.  
늦게 도다랗는 데이터가 집계 속도에 미치는 영향에 관해 알아보자

## 프로세스 시간과 이벤트 시간.
모바일 앱 같은 경우에는 며칠 정도의 지연을 예측해서 데이터 분석을 고려해야 한다.  

클라이언트 상에서 메세지가 생성된 시간을 **이벤트 시간(event time)**, 서버가 처리하는 시간을 **프로세스 시간(process time)**이라고 한다.
- 데이터 분석의 대상이 되는 것은 이벤트 시간이기 때문에 이 시간의 차이가 성가신 문제를 일으킨다.  

## 프로세스 시간에 의한 분할과 문제점
늦게 도달하는 데이터가 있다는 것은 과거의 집계 결과가 매일 조금씩 바뀐다는 것을 의미한다.  
- 보다 실태에 가까운 집계 결과를 얻기 위해서는 이벤트 시간보다 며칠 정도 지난 시점에 소급해 집계해야 한다.  

분산 스토리지에 데이터를 넣는 단계에서는 이벤트 시간이 아니라 프로세스 시간을 사용하는 것이 보통이다.  
- 이벤트 시간으로 정렬되지 않은 데이터를 모두 검색하는 과정때문에 시스템에 부하가 온다.  
- 이런 과정은 피해야 한다.

## 시계열 인덱스
이벤트 시간 취급을 효율화하기 위해 데이터를 정렬하는 것을 고려해봐야 한다.  

하나는 RDB에서 인덱스를 만드는 것과 마찬가지로, 이벤트 시간에 대해 인덱스를 만드는 것이다. 
- Cassandara와 같은 시계열 인덱스에 대응하는 분산 데이터베이스를 이용하면 처음부터 이벤트 시간으로 인덱스 된 테이블을 만들 수 있다.  
- 시계열 인덱스를 사용하면 매우 짧은 범위의 특정 시간에 맞춘 데이터 집계를 빠르게 실행할 수 있다.  
  - 정해진 시간에 발생한 이벤트를 조사하거나, 실시간 대시보드를 만드는 경우에 유용하다.
- 장기간에 걸쳐서 대량의 데이터를 집계하는 경우에는 분산 데이터베이스가 그다지 효율적이지 않다.
  - 장기적인 데이터 분석에는 더욱 집계 효율이 높은 열 지향 스토리지를 지속적으로 만들어줘야 한다.


## 조건절 푸시다운
열 지향 스토리지에서는 RDB와 동등한 인덱스를 만들 수 없지만, 처음에 데이터를 정렬할 수 있다.  

열 지향 스토리지는 칼럼 단위읭 통계 정보를 이용하여 최적화가 이루어진다.  
- 예를들어, 시간이면 각 컬럼의 최솟값과 최댓값 등이 모든 파일에 메타 정보로 저장되어 있으며, 그런 정보를 참고하여 어떤 파일의 어떤 부분에 원하는 데이터가 포함되어 있는지 알 수 있다.  
- 이 통계를 이용하여 필요 최소한의 데이터만을 읽도록 하는 최적화를 **조건절 푸시 다운(predicate pushdown)**이라고 한다.  

## 이벤트 시간에 의한 분할
프로세스 시간으로 파일을 나누고 있는 한, 동일 이벤트 시간 데이터가 아무래도 다수의 파일에 분산된다.  
- 따라서, 정확한 집계 결과를 얻기 위해서는 매우 많은 파일을 열어봐야 한다.  
- 테이블 파티셔닝 중 시간을 이용하여 분할된 테이블을 **시계열 테이블(time-series table)**이라고 한다.  

### 데이터 마트를 이벤트 시간으로 정렬하기
더 좋은 방법은 데이터 마트만이 이벤트 시간에 의한 정렬을 고려하도록 해두는 것이다.
- 데이터 수집 단계에서는 이벤트 시간을 따지지 않고 프로세스 시간만을 사용하여 데이터를 저장한다.  
- 그리고 데이터 마트를 만드는 단계에서 이벤트 시간에 의한 정렬을 함께 하도록 한다.