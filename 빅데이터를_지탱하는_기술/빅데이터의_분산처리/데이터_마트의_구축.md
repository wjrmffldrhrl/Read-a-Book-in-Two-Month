# 데이터 마트의 구축
분산 시스템이 준비되면 시각화를 위해 데이터 마트를 만드는 절차에 들어간다.

## 팩트 테이블
팩트 테이블의 작성에는 **추가(append)**와 **치환(replace)** 두 가지 방법이 있다.   
- 추가
    - 새로 도착한 데이터만을 증분으로 추가한다.
    - `INSERT INTO`
- 치환
    - 과거의 데이터를 포함하여 테이블 전체를 치환한다.
    - `CREATE TABLE`


### 테이블 파티셔닝
효율만 생각하면 추가가 압도적으로 유리하다.  
그러나 추가에는 아래와 같은 잠재적인 문제점들이 있다.
- 추가에 실패한 것을 알아채지 못하면 팩트 테이블의 일부에 결손이 발생한다.
- 추가를 잘못해서 여러 번 실행하면 팩트 테이블의 일부가 중복된다.
- 나중에 팩트 테이블을 다시 만들고 싶은 경우의 관리가 복잡해진다.


이러한 문제가 일어날 가능성을 줄이기 위해 **테이블 파티셔닝(table partitioning)**이라는 기술을 사용한다.  

> 테이블 파티셔닝이란?  
하나의 테이블을 여러 물리적인 파티션으로 나눔으로써 파티션 단위로 정리하여 데이터를 쓰거나 삭제할 수 있도록 하는 것이며, 주로 1일 1회 또는 1시간에 1회라는 식으로 자주 새 파티션을 만들고 그것을 팩트 테이블에 붙여놓는다. 각 파티션은 매번 교체하도록 하고, 만약 이미 존재한다면 덮어쓴다.  


### 데이터 마트의 치환
데이터 마트의 양은 한정되어 있기 때문에, 상당히 거대한 테이블을 만들지 않는 한 매번 치환하기는 어렵지 않다.  
- 장점
  - 데이터가 중복되거나 빠트릴 가능성이 거의 없다.
  - 테이블을 처음부터 다시 만들고 싶다면 쿼리를 한번 실행하기만 하면 된다.
  - 스키마 변경에도 유연하다.
  - 오래된 데이터는 자동으로 지워지므로 데이터 마트가 계속 확대되는 일도 없다.
- 단점
  - 처리 시간.
    - 데이터 양이 너무 많다면 쓰는 데 시간이 오래 걸리므로 현실적이지 못하다.  


### 집계 테이블
팩트 테이블을 어느정도 모아서 집계하면 집계하면 데이터 양이 크게 줄어든다. 이것을 **집계 테이블(summary yable)**이라고 한다.  
일일 집계를 잘 만들면 원래의 데이터가 아무리 대량으로 있어도 데이터 마트는 그다지 커지지 않는다.

