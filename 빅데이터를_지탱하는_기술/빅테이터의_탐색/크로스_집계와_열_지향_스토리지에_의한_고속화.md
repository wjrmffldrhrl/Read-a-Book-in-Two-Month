# 크로스 집계의 기본
## 트랜잭션 테이블, 크로스 테이블, 피벗 테이블
### 크로스 테이블
||2017년 1월|2017년 2월|2017년 3월|
|---|---|---|---|
|상품 A|57,500|57,500|60,000|
|상품 B|2,400|5,800|12,400|  

행 방향으로는 상품명이 나열되고, 열 방향으로는 매출 월이 나열된다. 행과 열이 교차하는 부분에 숫자 데이터가 들어가기 때문에 이를 **크로스 테이블**이라고 부른다.  
크로스 테이블은 보기 편하지만 데이터베이스에서는 다루기 어려운 데이터 형식이다.   

  
  
### 트랜잭션 테이블
|매출 월|상품 명|금액|
|---|---|---|
|2017년 1월|상품 A|57,500|
|2017년 1월|상품 B|2,400|
|2017년 2월|상품 A|57,500|
|2017년 2월|상품 B|5,800|
|2017년 3월|상품 A|60,000|
|2017년 3월|상품 B|12,400|  

보고서의 바탕이 되는 데이터는 위와 같은 행 방향으로만 증가하는(데이터베이스에 적합한) **트랜잭션 테이블** 형태여야 한다.  

이런 트랜잭션 테이블에서 크로스 테이블로 변환하는 과정을 **크로스 집계**라고 한다. 소량의 데이터를 크로스 집계하는데 편리한 것이 스프레드시트의 **피벗 테이블**기능이다.  

## SQL에 의한 테이블의 집계
대량의 데이터를 크로스 집계하려면 SQL을 이용하여 데이터집계, 즉 `sum()`과 같은 **집계 함수**를 이용해 데이터양 감소를 고려할 필요가 있다.  

# 열 지향 스토리지에 의한 고속화
메모리에 다 올라가지 않을 정도의 대량의 데이터를 신속하게 집계하려면, 미리 데이터를 집계에 적합한 형태로 변환하는 것이 필요하다.  

## 데이터베이스 지연 줄이기  
초 단위로 데이터를 집계하려면 처음부터 그것을 예상해서 시스템을 마련해야 한다.  

원 데이터는 용량적인 제약이 적어서 대량의 데이터를 처리할 수 있는 데이터 레이크와 데이터 웨어하우스에 저장한다. 거기에서 원하는 데이터를 추출하여 데이터 마트를 구축하고 여기에서는 항상 초 단위의 응답을 얻을 수 있도록 한다.  

데이터 레이크 --(데이터 집계)--> 데이터 마트 --(크로스 집계)--> 시각화 도구 

### 데이터 처리의 지연
데이터 마트를 만들 때는 가급적 지연이 적은 데이터베이스가 있어야 하는데, 가장 간단한 방법은 모든 데이터를 메모리에 올리는 것이다.  

만약 한 레코드의 크기가 500바이트라고 하면 천만 레코드의 경우는 5GB이므로 MySQL이나 PostreSQL등의 일반적인 RDB가 데이터 마트에 적합하다.  
그러나 메모리가 부족해지면 RDB는 급격히 성능이 저하되므로, 수억 레코드를 초과하는 데이터 집계에서는 항상 디바이스 I/O가 발생한다고 가정하고 어떻게 효율화할 것인지 고려해야한다.  


### **압축**과 **분산**에 의해 지연 줄이기